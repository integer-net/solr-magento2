box: mageinferno/magento2-php:7.1-fpm-0
services:
  - id: integernet/mysql_ci:5.6
    env:
      MYSQL_ROOT_PASSWORD: root
  - id: integernet/solr_ci:1.6.0
build-2.1:
  steps:
    - install-packages:
        packages: git zip mysql-client libmcrypt-dev libfreetype6-dev libjpeg62-turbo-dev libmcrypt-dev libpng12-dev netcat-openbsd
    - add-ssh-key:
        keyname: GITHUB_DEPLOY
        host: github.com
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
        type: rsa
    - script:
        name: "Wait for MySQL connection"
        code: |
          while ! nc -q 1 $MYSQL_CI_PORT_3306_TCP_ADDR $MYSQL_CI_PORT_3306_TCP_PORT </dev/null; do echo -n . && sleep 3; done
    - script:
        name: set up test system
        code: build/install-magento.sh 2.1.10
    - script:
        name: run unit tests
        cwd: /srv/www/vendor/integer-net/solr-magento2
        code: php ../../phpunit/phpunit/phpunit
    - script:
        name: run integration tests
        code: build/integration-tests.sh
build-2.2:
  steps:
    - install-packages:
        packages: git zip mysql-client libmcrypt-dev libfreetype6-dev libjpeg62-turbo-dev libmcrypt-dev libpng12-dev netcat-openbsd
    - add-ssh-key:
        keyname: GITHUB_DEPLOY
        host: github.com
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
        type: rsa
    - script:
        name: "Wait for MySQL connection"
        code: |
          while ! nc -q 1 $MYSQL_CI_PORT_3306_TCP_ADDR $MYSQL_CI_PORT_3306_TCP_PORT </dev/null; do echo -n . && sleep 3; done
    - script:
        name: set up test system
        code: build/install-magento.sh 2.2.1
    - script:
        name: run unit tests
        cwd: /srv/www/vendor/integer-net/solr-magento2
        code: php ../../phpunit/phpunit/phpunit
    - script:
        name: run integration tests
        code: build/integration-tests.sh
